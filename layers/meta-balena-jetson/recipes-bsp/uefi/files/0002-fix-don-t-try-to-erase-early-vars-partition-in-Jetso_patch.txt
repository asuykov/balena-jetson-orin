From ca9deb161bb3e6570f24906cbed9477c930abc8a Mon Sep 17 00:00:00 2001
From: Alexandru Costache <alexandru@balena.io>
Date: Mon, 24 Jun 2024 17:11:27 +0300
Subject: [PATCH 2/3] fix: don't try to erase early vars partition in Jetson

Part of resetting the settings from the UEFI menu entails erasing the
Early Variables partition, but this partition isn't present on Jetson
targets and sending this request to StMM would result in an ASSERT from
the secure code.

Backported-from: https://github.com/NVIDIA/edk2-nvidia/commit/1b61c7443e37c8673934135ecdf5ef4d86aca2d6

Signed-off-by: Girish Mahadevan <gmahadevan@nvidia.com>
Reviewed-by: Ashish Singhal <ashishsingha@nvidia.com>
---
 .../Library/FwVariableLib/FwVariableLib.c     | 27 +++++++++++--------
 .../Library/FwVariableLib/FwVariableLib.inf   |  4 +--
 2 files changed, 18 insertions(+), 13 deletions(-)

diff --git a/Silicon/NVIDIA/Library/FwVariableLib/FwVariableLib.c b/Silicon/NVIDIA/Library/FwVariableLib/FwVariableLib.c
index 3d14f655..21e4d81b 100644
--- a/Silicon/NVIDIA/Library/FwVariableLib/FwVariableLib.c
+++ b/Silicon/NVIDIA/Library/FwVariableLib/FwVariableLib.c
@@ -2,8 +2,7 @@
 
   FwVariableLib - Firmware variable support library
 
-  Copyright (c) 2023 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
-
+  SPDX-FileCopyrightText: Copyright (c) 2023 - 2024, NVIDIA CORPORATION & AFFILIATES. All rights reserved.
   SPDX-License-Identifier: BSD-2-Clause-Patent
 
 **/
@@ -17,6 +16,7 @@
 #include <Library/UefiBootServicesTableLib.h>
 #include <Library/UefiRuntimeServicesTableLib.h>
 #include <Library/FwVariableLib.h>
+#include <Library/TegraPlatformInfoLib.h>
 #include <Protocol/MmCommunication2.h>
 #include <Guid/NVIDIAMmMb1Record.h>
 #include <NVIDIAConfiguration.h>
@@ -167,6 +167,7 @@ FwVariableDeleteAll (
   EFI_GUID    CurrentGuid;
   EFI_GUID    NextGuid;
   UINTN       NameSize;
+  UINTN       ChipId;
 
   CurrentName = NULL;
   NextName    = NULL;
@@ -227,15 +228,19 @@ FwVariableDeleteAll (
     goto CleanupAndReturn;
   }
 
-  Status = EraseMb1VariablePartition ();
-  if (EFI_ERROR (Status)) {
-    DEBUG ((
-      DEBUG_ERROR,
-      "%a: Failed to Erase Mb1 Var Partition %r\n",
-      __FUNCTION__,
-      Status
-      ));
-    goto CleanupAndReturn;
+  ChipId = TegraGetChipID ();
+
+  if (ChipId == TH500_CHIP_ID) {
+    Status = EraseMb1VariablePartition ();
+    if (EFI_ERROR (Status)) {
+      DEBUG ((
+        DEBUG_ERROR,
+        "%a: Failed to Erase Mb1 Var Partition %r\n",
+        __FUNCTION__,
+        Status
+        ));
+      goto CleanupAndReturn;
+    }
   }
 
   Status = EFI_SUCCESS;
diff --git a/Silicon/NVIDIA/Library/FwVariableLib/FwVariableLib.inf b/Silicon/NVIDIA/Library/FwVariableLib/FwVariableLib.inf
index 5ba138c3..856e1973 100644
--- a/Silicon/NVIDIA/Library/FwVariableLib/FwVariableLib.inf
+++ b/Silicon/NVIDIA/Library/FwVariableLib/FwVariableLib.inf
@@ -2,8 +2,7 @@
 #
 #  FwVariableLib - Firmware variable support library
 #
-#  Copyright (c) 2023 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
-#
+#  SPDX-FileCopyrightText: Copyright (c) 2023 - 2024, NVIDIA CORPORATION & AFFILIATES. All rights reserved.
 #  SPDX-License-Identifier: BSD-2-Clause-Patent
 #
 ##
@@ -26,6 +25,7 @@
 [LibraryClasses]
   BaseLib
   ReportStatusCodeLib
+  TegraPlatformInfoLib
 
 [Guids]
   gNVIDIAMmMb1RecordGuid
-- 
2.34.1

