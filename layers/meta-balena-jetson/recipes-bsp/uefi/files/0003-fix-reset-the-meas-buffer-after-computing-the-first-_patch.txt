From 627a6814eedae481243fa30cdf96c894929bf0c5 Mon Sep 17 00:00:00 2001
From: Alexandru Costache <alexandru@balena.io>
Date: Mon, 24 Jun 2024 17:11:55 +0300
Subject: [PATCH 3/3] fix: reset the meas buffer after computing the first
 measurement

After using the measurement buffer to verify the variable
store, reset it back to 0.
Without this change, if a var write comes in the FVB driver
treats the contents of the measurement buffer as valid to be
committed and it throws the state machine off.
Also return an error when checking if the Measurement partition
is zero or erased to force a re-init of the VarStore.

Backported-from: https://github.com/NVIDIA/edk2-nvidia/commit/615288ae7635103213e81e7356b3e47e283306f5

Signed-off-by: Girish Mahadevan <gmahadevan@nvidia.com>
Reviewed-by: Ashish Singhal <ashishsingha@nvidia.com>
---
 .../FvbNorFlashDxe/FvbNorFlashStandaloneMm.c        | 13 +++++++++++--
 Silicon/NVIDIA/Drivers/FvbNorFlashDxe/VarIntCheck.c |  5 +++--
 2 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/Silicon/NVIDIA/Drivers/FvbNorFlashDxe/FvbNorFlashStandaloneMm.c b/Silicon/NVIDIA/Drivers/FvbNorFlashDxe/FvbNorFlashStandaloneMm.c
index 9575cb47..b8bc03d4 100644
--- a/Silicon/NVIDIA/Drivers/FvbNorFlashDxe/FvbNorFlashStandaloneMm.c
+++ b/Silicon/NVIDIA/Drivers/FvbNorFlashDxe/FvbNorFlashStandaloneMm.c
@@ -1004,6 +1004,8 @@ MmFvbSmmVarReady (
   @param CheckVariableStore   - TRUE if the variable data should be checked
   @param NorFlashProtocol     - Pointer to nor flash protocol
   @param FlashAttributes      - Pointer to flash attributes for the nor flash partition is on
+  @param MeasurementOffset    - Offset of the Measuremet partition
+  @param MeasurementSize      - Size of the Measurement partition
 
 **/
 EFI_STATUS
@@ -1075,7 +1077,12 @@ ValidateFvHeader (
     // then check if the partition is erased. If it is erased, then re-initialize the varstore, as it
     // could be a possible tamper.
     if (CheckVarStoreIntegrity == TRUE) {
-      if (IsMeasurementPartitionErasedOrZero (NorFlashProtocol, MeasurementOffset, MeasurementPartitionSize) == TRUE) {
+      if (IsMeasurementPartitionErasedOrZero (
+            NorFlashProtocol,
+            MeasurementOffset,
+            MeasurementPartitionSize
+            ) == TRUE)
+      {
         DEBUG ((DEBUG_ERROR, "%a: No Valid Measurements found. Re-initializing the Variable Store\n", __FUNCTION__));
         Status = EraseMeasurementPartition (NorFlashProtocol, MeasurementOffset, MeasurementPartitionSize);
         if (EFI_ERROR (Status)) {
@@ -1085,8 +1092,10 @@ ValidateFvHeader (
             __FUNCTION__,
             Status
             ));
-          return Status;
         }
+
+        // return EFI_NOT_FOUND to force a re-init.
+        return EFI_NOT_FOUND;
       }
     }
   }
diff --git a/Silicon/NVIDIA/Drivers/FvbNorFlashDxe/VarIntCheck.c b/Silicon/NVIDIA/Drivers/FvbNorFlashDxe/VarIntCheck.c
index 5a73607f..53d5fc2a 100644
--- a/Silicon/NVIDIA/Drivers/FvbNorFlashDxe/VarIntCheck.c
+++ b/Silicon/NVIDIA/Drivers/FvbNorFlashDxe/VarIntCheck.c
@@ -323,7 +323,7 @@ GetWriteOffset (
   }
 
   if ((*Offset % This->BlockSize) == 0) {
-    DEBUG ((DEBUG_ERROR, "Erasing BLock %lu\n", *Offset));
+    DEBUG ((DEBUG_INFO, "Erasing BLock %lu\n", *Offset));
     Status = NorFlashProtocol->Erase (
                                  NorFlashProtocol,
                                  (*Offset / This->BlockSize),
@@ -1019,6 +1019,7 @@ ExitVarIntValidate:
     }
   }
 
+  ZeroMem (This->CurMeasurement, This->MeasurementSize);
   return Status;
 }
 
@@ -1069,7 +1070,7 @@ VarIntInit (
   }
 
   DEBUG ((
-    DEBUG_ERROR,
+    DEBUG_INFO,
     "%a: Partition Start 0x%lx %lu Size %u\n",
     __FUNCTION__,
     PartitionStartOffset,
-- 
2.34.1

