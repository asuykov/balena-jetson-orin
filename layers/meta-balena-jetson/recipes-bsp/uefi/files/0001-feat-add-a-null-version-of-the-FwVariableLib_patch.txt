From 8f99f1efdd6782f9b4ec35b1c6927a196797a0b5 Mon Sep 17 00:00:00 2001
From: Alexandru Costache <alexandru@balena.io>
Date: Mon, 24 Jun 2024 17:10:40 +0300
Subject: [PATCH 1/3] feat: add a null version of the FwVariableLib

Add a null version of the FwVariableLib that targets using emulated
variable store can include.

Backported-from:
https://github.com/NVIDIA/edk2-nvidia/commit/92bc1c3468ec44f5c04eefe2f91844d92bdc6219

Signed-off-by: Girish Mahadevan <gmahadevan@nvidia.com>
Reviewed-by: Ashish Singhal <ashishsingha@nvidia.com>
---
 Platform/NVIDIA/TegraVirt/TegraVirt.dsc       |  2 +-
 .../FwVariableLibNull/FwVariableLib.inf       | 27 +++++++++++++++++++
 .../FwVariableLibNull/FwVariableLibNull.c     | 27 +++++++++++++++++++
 3 files changed, 55 insertions(+), 1 deletion(-)
 create mode 100644 Silicon/NVIDIA/Library/FwVariableLibNull/FwVariableLib.inf
 create mode 100644 Silicon/NVIDIA/Library/FwVariableLibNull/FwVariableLibNull.c

diff --git a/Platform/NVIDIA/TegraVirt/TegraVirt.dsc b/Platform/NVIDIA/TegraVirt/TegraVirt.dsc
index f457392c..d52d6e69 100644
--- a/Platform/NVIDIA/TegraVirt/TegraVirt.dsc
+++ b/Platform/NVIDIA/TegraVirt/TegraVirt.dsc
@@ -91,7 +91,7 @@
   TpmPlatformHierarchyLib|SecurityPkg/Library/PeiDxeTpmPlatformHierarchyLibNull/PeiDxeTpmPlatformHierarchyLib.inf
   Tcg2PhysicalPresenceLib|Silicon/NVIDIA/Library/DxeTcg2PhysicalPresenceLibNull/DxeTcg2PhysicalPresenceLibNull.inf
   IpmiBaseLib|IpmiFeaturePkg/Library/IpmiBaseLib/IpmiBaseLib.inf
-  FwVariableLib|Silicon/NVIDIA/Library/FwVariableLib/FwVariableLib.inf
+  FwVariableLib|Silicon/NVIDIA/Library/FwVariableLibNull/FwVariableLib.inf
 
   # AndroidBootDxe Libraries
   NvgLib|Silicon/NVIDIA/Library/NvgLib/NvgLib.inf
diff --git a/Silicon/NVIDIA/Library/FwVariableLibNull/FwVariableLib.inf b/Silicon/NVIDIA/Library/FwVariableLibNull/FwVariableLib.inf
new file mode 100644
index 00000000..23412d20
--- /dev/null
+++ b/Silicon/NVIDIA/Library/FwVariableLibNull/FwVariableLib.inf
@@ -0,0 +1,27 @@
+## @file
+#
+#  FwVariableLib - Firmware variable support library
+#
+#  SPDX-FileCopyrightText: Copyright (c) 2024 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
+#  SPDX-License-Identifier: BSD-2-Clause-Patent
+#
+##
+
+[Defines]
+  INF_VERSION                    = 0x00010005
+  BASE_NAME                      = FwVariableLibNull
+  FILE_GUID                      = 1a2fdba4-93fa-4b64-bb92-2c5792a76caa
+  MODULE_TYPE                    = BASE
+  VERSION_STRING                 = 1.0
+  LIBRARY_CLASS                  = FwVariableLib
+
+[Sources.common]
+  FwVariableLibNull.c
+
+[Packages]
+  MdePkg/MdePkg.dec
+  Silicon/NVIDIA/NVIDIA.dec
+
+[LibraryClasses]
+  BaseLib
+
diff --git a/Silicon/NVIDIA/Library/FwVariableLibNull/FwVariableLibNull.c b/Silicon/NVIDIA/Library/FwVariableLibNull/FwVariableLibNull.c
new file mode 100644
index 00000000..729882d9
--- /dev/null
+++ b/Silicon/NVIDIA/Library/FwVariableLibNull/FwVariableLibNull.c
@@ -0,0 +1,27 @@
+/** @file
+
+  FwVariableLibNull - Null Version of the Firmware variable support library
+
+  SPDX-FileCopyrightText: Copyright (c) 2024, NVIDIA CORPORATION & AFFILIATES. All rights reserved.
+  SPDX-License-Identifier: BSD-2-Clause-Patent
+
+**/
+
+#include <Uefi.h>
+#include <Library/DebugLib.h>
+#include <Library/BaseLib.h>
+
+/**
+  Delete all Firmware Variables
+  Stub version that returns success only.
+
+  @retval         EFI_SUCCESS          All variables deleted
+
+**/
+EFI_STATUS
+EFIAPI
+FwVariableDeleteAll (
+  )
+{
+  return EFI_SUCCESS;
+}
-- 
2.34.1

